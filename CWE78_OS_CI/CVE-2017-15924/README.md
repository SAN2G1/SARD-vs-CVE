# 📁 CVE-2017-15924

## 🔍 취약점 개요

**🔗 [커밋 링크](https://github.com/shadowsocks/shadowsocks-libev/commit/c67d275803dc6ea22c558d06b1f7ba9f94cd8de3)** | **🔗 [CVE 링크](https://www.cvedetails.com/cve/CVE-2017-15924/)** | **🔗 [CWE 링크](https://cwe.mitre.org/data/definitions/78.html)**

> shadowsocks-libev 3.1.0의 ss-manager에서 127.0.0.1 UDP 트래픽을 통해 수신된 JSON 설정 요청의 부적절한 파싱으로 인해 쉘 메타문자를 통한 명령어 인젝션이 가능한 OS Command Injection 취약점입니다.

※ Shadowsocks-libev는 임베디드 장치와 저사양 박스를 위한 경량 보안 SOCKS5 프록시입니다. ss-manager는 다중 사용자를 위한 shadowsocks 서버를 제어하며, 필요에 따라 새로운 서버를 생성합니다.

* **Source**: `get_server()` 함수 최상단에서 JSON 파싱 후 `server->port`, `server->method` 등의 외부값을 검증없이 복사함
* **취약 조건**: JSON 설정 요청의 `method` 파라미터에서 입력값 검증 없이 쉘 명령어 구성
* **Trace**: `struct_command_line()` 함수는 `get_server()` 함수에서 검증되지 않고 복사된 입력값 `server->method`, `server->port`을 `snprintf()` 함수의 `%s` 포맷에 직접 사용 -> 쉘 메타문자 삽입 벡터 발생
* **Sink**: `add_server()` 함수는 `construct_command_line()`로부터 반환된 `cmd` 를  `system()` 함수의 인자로 전달함

---

## 탐지 결과 요약
CVE 설명에 나온 취약한 함수들(add_server, build_config, construct_command_line)에 대한 슬라이스만 고려했을 때,

| 총 슬라이스 수 |  취약으로 탐지 | 정상으로 탐지 |
| --------  | -- | -- |
| 48개       | 0개 | 48개 |

add_server(), build_config(), construct_command_line()에서 추출한 슬라이스 중, Sink(`system()` 함수) 관련 슬라이스는 1건 있었으나, **정상으로 탐지됨**

|FileName |Caller                |Source|Sink |idx|CWE-ID|category      |criterion|line|label|token_length|predict|
|---------|----------------------|------|-----|---|------|--------------|---------|----|-----|------------|-------|
|manager.c|add_server            |False |False|71 |CWE-  |CallExpression|system   |486 |-3   |67          |0      |

#### SARD는 잘 탐지하는데 이 CVE는 탐지 못했던 이유

1. **슬라이싱 범위 불완전**
   - 슬라이스가 `system()` 함수를 criterion 으로 인식하여 슬라이싱했으나 범위에 `system()` 함수가 포함되지 않고 직전 라인까지만 코드를 슬라이싱함.
   - 설령 슬라이스에 `system()` 함수가 포함되었더라도 인자 cmd의 조합 과정이 300라인 이상 떨어진 위치에서 진행되어 슬라이스 범위에 포함되지 않음.
   - 때문에 CVE-2017-15924의 원인 분석을 위해서는 source와 trace, sink 모두 포함된 슬라이스가 필요함.
        기대하는 슬라이스
        ```
        static struct server *
        get_server(char *buf, int len)
        {...
                struct server *server = ss_malloc(sizeof(struct server));
                memset(server, 0, sizeof(struct server));
                if (obj->type == json_object) {
                        int i = 0;
                        for (i = 0; i < obj->u.object.length; i++) {
                        char *name        = obj->u.object.values[i].name;
                        json_value *value = obj->u.object.values[i].value;
                        if (strcmp(name, "server_port") == 0) {
                                if (value->type == json_string) {
                                strncpy(server->port, value->u.string.ptr, 8);
                                } else if (value->type == json_integer) {
                                snprintf(server->port, 8, "%" PRIu64 "", value->u.integer);
                                }
                        ...
                        } else if (strcmp(name, "method") == 0) {
                                if (value->type == json_string) {
                                server->method = strdup(value->u.string.ptr);
                                }
                ...
                json_value_free(obj);
                return server;
        }

        construct_command_line(struct manager_ctx *manager, struct server *server)
        {
                static char cmd[BUF_SIZE];
                char *method = manager->method;
                int i;

                build_config(working_dir, server);

                if (server->method) method = server->method;
                memset(cmd, 0, BUF_SIZE);
                snprintf(cmd, BUF_SIZE,
                        "%s -m %s --manager-address %s -f %s/.shadowsocks_%s.pid -c %s/.shadowsocks_%s.conf",
                        executable, method, manager->manager_address,
                        working_dir, server->port, working_dir, server->port);
                ...
                return cmd;
        }

        ...

        add_server(struct manager_ctx *manager, struct server *server)
        {
                ...
                char *cmd = construct_command_line(manager, server);
                if (system(cmd) == -1) {
                        ERROR("add_server_system");
                        return -1;
                }

                return 0;
        }
        ```
        원본 슬라이스

        ```c
        {
        "FileName": "manager.c",
        "Caller": "add_server",
        "Source": false,
        "Sink": false,
        "idx": 71,
        "CWE-ID": "CWE-",
        "category": "CallExpression",
        "criterion": "system",
        "line": 486,
        "label": -3,
        "slices": [
            "add_server(struct manager_ctx *manager, struct server *server)\n",
            "    int ret = check_port(manager, server);\n",
            "    if (ret == -1) {\n",
            "    char *cmd = construct_command_line(manager, server);\n"
        ]
        }
        ```

---

## 취약점 세부 사항

### 📁 관련 파일 소개
| 파일명            | 설명              |
| -------------- | --------------- |
| `before_manager.c` | 취약 코드 (수정 전) 포함 |
| `after_manager.c`  | 개선 코드 (수정 후) 포함 |

---

### ❗️ 취약 코드

#### Source: `before_manager.c:265-285`
```c 
static struct server *
get_server(char *buf, int len)
{
        //...
        struct server *server = ss_malloc(sizeof(struct server));
        memset(server, 0, sizeof(struct server));
        if (obj->type == json_object) {
                int i = 0;
                for (i = 0; i < obj->u.object.length; i++) {
                char *name        = obj->u.object.values[i].name;
                json_value *value = obj->u.object.values[i].value;
                if (strcmp(name, "server_port") == 0) {
                        if (value->type == json_string) {
                        strncpy(server->port, value->u.string.ptr, 8);
                        } else if (value->type == json_integer) {
                        snprintf(server->port, 8, "%" PRIu64 "", value->u.integer);
                        }
                //...
                } else if (strcmp(name, "method") == 0) {
                        if (value->type == json_string) {
                        server->method = strdup(value->u.string.ptr);
                        }
        //...
        json_value_free(obj);
        return server;
}

```

**문제점**: JSON 설정 요청이나 설정 파일에서 파싱된 인자들이 적절한 검증 없이 `add_server` 함수로 전달되어 **명령어 인젝션**이 발생할 수 있습니다.

#### Trace: `before_manager.c:124-137`
```c
static char *
construct_command_line(struct manager_ctx *manager, struct server *server)
{
    static char cmd[BUF_SIZE];
    char *method = manager->method;
    
    build_config(working_dir, server);
    
    if (server->method) method = server->method;
    memset(cmd, 0, BUF_SIZE);
    snprintf(cmd, BUF_SIZE,
             "%s -m %s --manager-address %s -f %s/.shadowsocks_%s.pid -c %s/.shadowsocks_%s.conf",
             executable, method, manager->manager_address,
             working_dir, server->port, working_dir, server->port);
    // ...
}         
```

#### Sink: `before_manager.c:486`
```c
static int
add_server(struct manager_ctx *manager, struct server *server)
{
    // ...
    char *cmd = construct_command_line(manager, server);
    if (system(cmd) == -1) { 
        ERROR("add_server_system");
        return -1;
    }
    return 0;
}
```

---

### ✅ 개선 코드

#### 1. **패치 위치**: `build_config.c:95,113-124`

```c
build_config(char *prefix, struct manager_ctx *manager, struct server *server)
{
//...
    if (server->method)
        fprintf(f, ",\n\"method\":\"%s\"", server->method);
    else if (manager->method)
        fprintf(f, ",\n\"method\":\"%s\"", manager->method);
    if (server->fast_open[0])
        fprintf(f, ",\n\"fast_open\": %s", server->fast_open);
    if (server->mode)
        fprintf(f, ",\n\"mode\":\"%s\"", server->mode);
    if (server->plugin)
        fprintf(f, ",\n\"plugin\":\"%s\"", server->plugin);
    if (server->plugin_opts)
        fprintf(f, ",\n\"plugin_opts\":\"%s\"", server->plugin_opts);
//...
}
```

**개선 방법**:
`manager` 정보를 함께 받아서, `server->method`가 없을 때 관리자 설정(`manager->method`) 을 대체 사용할 수 있게 합니다.
* `build_config()` 함수에 `manager` 파라미터를 추가하여 전역 설정에 접근 가능
* `server->method`가 없을 경우 `manager->method`를 사용하는 안전한 대체 로직 구현
* `method` 값을 설정 파일에만 기록하여 기존 `-m %s` 옵션으로 전달하지 않고 JSON config 파일 안에만 남도록 관리

#### 2. **패치 위치**: `after_manager.c:142-144`

```c
static char *
construct_command_line(struct manager_ctx *manager, struct server *server)
{
    static char cmd[BUF_SIZE];
    int i;
    int port;

    port = atoi(server->port);

    build_config(working_dir, manager, server);

    memset(cmd, 0, BUF_SIZE);
    snprintf(cmd, BUF_SIZE,
             "%s --manager-address %s -f %s/.shadowsocks_%d.pid -c %s/.shadowsocks_%d.conf",
             executable, manager->manager_address, working_dir, port, working_dir, port);
}
```

**개선 방법**:

이 패치는 명령어 인젝션의 직접적인 경로를 차단합니다.

* `-m %s` 옵션 제거: `method` 파라미터를 명령줄에서 완전히 제거하여 인젝션 벡터 차단.
* 정수 변환: `server->port`를 `atoi()`로 정수 변환하여 문자열 인젝션 방지.


---

## 탐지 결과

|FileName |Caller                |Source|Sink |idx|CWE-ID|category      |criterion|line|label|token_length|predict|
|---------|----------------------|------|-----|---|------|--------------|---------|----|-----|------------|-------|
|manager.c|build_config          |FALSE |FALSE|0  |CWE-  |CallExpression|strlen   |98  |-3   |375         |0      |
|manager.c|build_config          |FALSE |FALSE|1  |CWE-  |CallExpression|strlen   |98  |-3   |375         |0      |
|manager.c|build_config          |FALSE |FALSE|2  |CWE-  |CallExpression|snprintf |101 |-3   |350         |0      |
|manager.c|build_config          |FALSE |FALSE|3  |CWE-  |CallExpression|fopen    |102 |-3   |375         |0      |
|manager.c|build_config          |FALSE |FALSE|4  |CWE-  |CallExpression|fprintf  |110 |-3   |338         |0      |
|manager.c|build_config          |FALSE |FALSE|5  |CWE-  |CallExpression|fprintf  |111 |-3   |359         |0      |
|manager.c|build_config          |FALSE |FALSE|6  |CWE-  |CallExpression|atoi     |111 |-3   |359         |0      |
|manager.c|build_config          |FALSE |FALSE|7  |CWE-  |CallExpression|fprintf  |112 |-3   |359         |0      |
|manager.c|build_config          |FALSE |FALSE|8  |CWE-  |CallExpression|fprintf  |113 |-3   |323         |0      |
|manager.c|build_config          |FALSE |FALSE|9  |CWE-  |CallExpression|fprintf  |114 |-3   |323         |0      |
|manager.c|build_config          |FALSE |FALSE|10 |CWE-  |CallExpression|fprintf  |115 |-3   |323         |0      |
|manager.c|build_config          |FALSE |FALSE|11 |CWE-  |CallExpression|fprintf  |116 |-3   |323         |0      |
|manager.c|build_config          |FALSE |FALSE|12 |CWE-  |CallExpression|fprintf  |117 |-3   |323         |0      |
|manager.c|build_config          |FALSE |FALSE|13 |CWE-  |CallExpression|fprintf  |118 |-3   |338         |0      |
|manager.c|build_config          |FALSE |FALSE|14 |CWE-  |CallExpression|fclose   |119 |-3   |338         |0      |
|manager.c|construct_command_line|FALSE |FALSE|15 |CWE-  |CallExpression|memset   |133 |-3   |904         |0      |
|manager.c|construct_command_line|FALSE |FALSE|16 |CWE-  |CallExpression|snprintf |134 |-3   |957         |0      |
|manager.c|construct_command_line|FALSE |FALSE|17 |CWE-  |CallExpression|strlen   |140 |-3   |904         |0      |
|manager.c|construct_command_line|FALSE |FALSE|18 |CWE-  |CallExpression|snprintf |141 |-3   |926         |0      |
|manager.c|construct_command_line|FALSE |FALSE|19 |CWE-  |CallExpression|strlen   |144 |-3   |904         |0      |
|manager.c|construct_command_line|FALSE |FALSE|20 |CWE-  |CallExpression|snprintf |145 |-3   |926         |0      |
|manager.c|construct_command_line|FALSE |FALSE|21 |CWE-  |CallExpression|strlen   |149 |-3   |904         |0      |
|manager.c|construct_command_line|FALSE |FALSE|22 |CWE-  |CallExpression|snprintf |150 |-3   |926         |0      |
|manager.c|construct_command_line|FALSE |FALSE|23 |CWE-  |CallExpression|strlen   |154 |-3   |904         |0      |
|manager.c|construct_command_line|FALSE |FALSE|24 |CWE-  |CallExpression|snprintf |155 |-3   |926         |0      |
|manager.c|construct_command_line|FALSE |FALSE|25 |CWE-  |CallExpression|strlen   |158 |-3   |904         |0      |
|manager.c|construct_command_line|FALSE |FALSE|26 |CWE-  |CallExpression|snprintf |159 |-3   |904         |0      |
|manager.c|construct_command_line|FALSE |FALSE|27 |CWE-  |CallExpression|strlen   |162 |-3   |904         |0      |
|manager.c|construct_command_line|FALSE |FALSE|28 |CWE-  |CallExpression|snprintf |163 |-3   |904         |0      |
|manager.c|construct_command_line|FALSE |FALSE|29 |CWE-  |CallExpression|strlen   |166 |-3   |904         |0      |
|manager.c|construct_command_line|FALSE |FALSE|30 |CWE-  |CallExpression|snprintf |167 |-3   |904         |0      |
|manager.c|construct_command_line|FALSE |FALSE|31 |CWE-  |CallExpression|strlen   |170 |-3   |904         |0      |
|manager.c|construct_command_line|FALSE |FALSE|32 |CWE-  |CallExpression|snprintf |171 |-3   |904         |0      |
|manager.c|construct_command_line|FALSE |FALSE|33 |CWE-  |CallExpression|strlen   |174 |-3   |904         |0      |
|manager.c|construct_command_line|FALSE |FALSE|34 |CWE-  |CallExpression|snprintf |175 |-3   |904         |0      |
|manager.c|construct_command_line|FALSE |FALSE|35 |CWE-  |CallExpression|strlen   |178 |-3   |904         |0      |
|manager.c|construct_command_line|FALSE |FALSE|36 |CWE-  |CallExpression|snprintf |179 |-3   |926         |0      |
|manager.c|construct_command_line|FALSE |FALSE|37 |CWE-  |CallExpression|strlen   |182 |-3   |904         |0      |
|manager.c|construct_command_line|FALSE |FALSE|38 |CWE-  |CallExpression|snprintf |183 |-3   |926         |0      |
|manager.c|construct_command_line|FALSE |FALSE|39 |CWE-  |CallExpression|strlen   |186 |-3   |904         |0      |
|manager.c|construct_command_line|FALSE |FALSE|40 |CWE-  |CallExpression|snprintf |187 |-3   |926         |0      |
|manager.c|construct_command_line|FALSE |FALSE|41 |CWE-  |CallExpression|strlen   |190 |-3   |904         |0      |
|manager.c|construct_command_line|FALSE |FALSE|42 |CWE-  |CallExpression|snprintf |191 |-3   |926         |0      |
|manager.c|construct_command_line|FALSE |FALSE|43 |CWE-  |CallExpression|strlen   |194 |-3   |904         |0      |
|manager.c|construct_command_line|FALSE |FALSE|44 |CWE-  |CallExpression|snprintf |195 |-3   |926         |0      |
|manager.c|construct_command_line|FALSE |FALSE|45 |CWE-  |CallExpression|strlen   |199 |-3   |904         |0      |
|manager.c|construct_command_line|FALSE |FALSE|46 |CWE-  |CallExpression|snprintf |200 |-3   |904         |0      |
|manager.c|add_server            |FALSE |FALSE|71 |CWE-  |CallExpression|system   |486 |-3   |67          |0      |