# 📁 CVE-2017-15108

## 🔍 취약점 개요
**🔗 [커밋 링크](https://cgit.freedesktop.org/spice/linux/vd_agent/commit/?id=8ba174816d245757e743e636df357910e1d5eb61)** | **🔗 [CVE 링크](https://nvd.nist.gov/vuln/detail/CVE-2017-15108)** | **🔗 [CWE 링크](https://cwe.mitre.org/data/definitions/78.html)**

> spice-vdagent의 save directory 과정 중 vdagent_file_xfers_data()에서 발생한 OS Command Injection 취약점입니다.

※ SPICE( Simple Protocol for Independent Computing Environments) 환경에서 사용하는 게스트 에이전트 프로그램입니다. 주로 가상 머신(VM) 내부에 설치되며, SPICE 프로토콜을 사용하는 가상화 솔루션(예: QEMU/KVM)의 게스트와 호스트 간 통신을 향상시키는 역할을 합니다.

* **취약 조건**: 입력값을 검증하지 않고
* **Sink**: 위험한 `system()` 함수 사용

## 탐지 결과 요약
cve 설명에 나온 취약한 함수(Caller, vdagent_file_xfers_data())에 대한 슬라이스만 고려했을 때,

| 총 슬라이스 수* |  정탐 | 미탐 |
| --------  | -- | -- |
| 15개       | 0개 | 15개 |

vdagent_file_xfers_data()에서 추출한 슬라이스 중, Sink(`system()` 함수) 관련 슬라이스는 1건 있었으나, **정상으로 탐지됨**

|FileName           |Caller                 |Source|Sink |idx|CWE-ID|category      |criterion|line|label|token_length|predict|
|-------------------|-----------------------|------|-----|---|------|--------------|---------|----|-----|------------|-------|
|before_file-xfers.c|vdagent_file_xfers_data|FALSE |FALSE|51 |CWE-  |CallExpression|system   |341 |-3   |161         |0      |

#### SARD는 잘 탐지하는데 이 CVE는 탐지 못했던 이유

1. **부적절한 criterion**
    - CWE78의 SARD/README.md에 따르면 
        > ```bash
        > sojeon@swlab-u2404:~/Documents/research/SARD-vs-CVE/CWE78_OS_CI/SARD$ xsv search -s predict 1 test_output.csv | xsv select criterion | uniq
        >    criterion
        >    strcat
        > ```
    - 이 취약점의 경우 criterion으로 strcat()이 잡히지 않아 정상으로 판단된 것으로 보임.

---

## 취약점 세부 사항
### ❗️ 취약 코드

**문제점**:
사용자 입력이 적절히 검증되지 않은 채로 `system()` 함수의 인자로 사용되어 **명령어 인젝션**이 발생할 수 있음.

#### Sink: `before_file-xfers.c:341`
```c
char buf[PATH_MAX];
snprintf(buf, PATH_MAX, "xdg-open '%s'&", xfers->save_dir);
status = system(buf); /* POTENTIAL FLAW */ 
```


### ✅ 개선 코드

**패치 위치**: `after_file-xfers.c:340`

```c
GError *error = NULL;
gchar *argv[] = { "xdg-open", xfers->save_dir, NULL };
if (!g_spawn_async(NULL, argv, NULL,
                        G_SPAWN_SEARCH_PATH,
                        NULL, NULL, NULL, &error)) {
    syslog(LOG_WARNING,
            "file-xfer: failed to open save directory: %s",
            error->message);
    g_error_free(error);
}
```

**개선 방법**:

* argv[] 배열을 통해 명령과 인자를 구분해서 처리함 → 쉘 해석 우회 불가능
* 또한, `system()` 함수 대신 안전한 g_spawn_async()로 대체

## 탐지 결과
|FileName           |Caller                 |Source|Sink |idx|CWE-ID|category      |criterion|line|label|token_length|predict|
|-------------------|-----------------------|------|-----|---|------|--------------|---------|----|-----|------------|-------|
|after_file-xfers.c |vdagent_file_xfers_data|FALSE |FALSE|20 |CWE-  |CallExpression|write    |326 |-3   |385         |0      |
|after_file-xfers.c |vdagent_file_xfers_data|FALSE |FALSE|21 |CWE-  |CallExpression|syslog   |332 |-3   |311         |0      |
|after_file-xfers.c |vdagent_file_xfers_data|FALSE |FALSE|22 |CWE-  |CallExpression|close    |334 |-3   |311         |0      |
|after_file-xfers.c |vdagent_file_xfers_data|FALSE |FALSE|23 |CWE-  |CallExpression|syslog   |344 |-3   |219         |0      |
|after_file-xfers.c |vdagent_file_xfers_data|FALSE |FALSE|24 |CWE-  |CallExpression|syslog   |352 |-3   |92          |0      |
|after_file-xfers.c |vdagent_file_xfers_data|FALSE |FALSE|25 |CWE-  |CallExpression|syslog   |357 |-3   |311         |0      |
|after_file-xfers.c |vdagent_file_xfers_data|FALSE |FALSE|26 |CWE-  |CallExpression|strerror |357 |-3   |311         |0      |
|before_file-xfers.c|vdagent_file_xfers_data|FALSE |FALSE|47 |CWE-  |CallExpression|write    |326 |-3   |309         |0      |
|before_file-xfers.c|vdagent_file_xfers_data|FALSE |FALSE|48 |CWE-  |CallExpression|syslog   |332 |-3   |246         |0      |
|before_file-xfers.c|vdagent_file_xfers_data|FALSE |FALSE|49 |CWE-  |CallExpression|close    |334 |-3   |246         |0      |
|before_file-xfers.c|vdagent_file_xfers_data|FALSE |FALSE|50 |CWE-  |CallExpression|snprintf |340 |-3   |277         |0      |
|before_file-xfers.c|vdagent_file_xfers_data|FALSE |FALSE|51 |CWE-  |CallExpression|system   |341 |-3   |161         |0      |
|before_file-xfers.c|vdagent_file_xfers_data|FALSE |FALSE|52 |CWE-  |CallExpression|syslog   |345 |-3   |92          |0      |
|before_file-xfers.c|vdagent_file_xfers_data|FALSE |FALSE|53 |CWE-  |CallExpression|syslog   |350 |-3   |246         |0      |
|before_file-xfers.c|vdagent_file_xfers_data|FALSE |FALSE|54 |CWE-  |CallExpression|strerror |350 |-3   |246         |0      |
