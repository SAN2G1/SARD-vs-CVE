# 📁 CVE-2015-8617

## 🔍 취약점 개요

**🔗 [커밋 링크](https://github.com/php/php-src/commit/b101a6bbd4f2181c360bd38e7683df4a03cba83e)** | **🔗 [CVE 링크](https://www.cvedetails.com/cve/CVE-2015-8617)**  | **🔗 [CWE 링크](https://cwe.mitre.org/data/definitions/134.html)** 

> PHP 7.0.1 이전 버전의 `Zend/zend_execute_API.c`의 `zend_throw_or_error` 함수 내부에서 외부 입력을 문자열 메시지로 포맷팅한 후, `zend_throw_error()`를 통해 포맷 문자열 해석이 이루어지는 방식에서 발생하는 \*\*형식 문자열 취약점(CWE-134)\*\*입니다. 공격자가 포맷 문자열을 조작하여 임의 코드 실행이나 비정상 동작을 유발할 수 있습니다.

* **Source**: 외부에서 제어 가능한 상수 이름(예: 클래스명 문자열)
* **취약 조건**: 상수가 존재하지 않을 때 예외 메시지를 출력하며 포맷 문자열에 유입됨
* **Sink**: `zend_throw_error()` – 포맷 문자열이 실제로 해석되는 함수

---

## 탐지 결과 요약

| 총 슬라이스 수 | 취약으로 탐지 | 정상으로 탐지 |
| -------- | ------- | ------- |
| 0개      | 0개      | 0개     |

\* Sink(`end_throw_error` 함수) 관련 슬라이스는 존재하지 않음.

---

#### SARD는 잘 탐지하는데 이 CVE는 탐지 못했던 이유

1. **부적절한 criterion**
   * 이 취약점의 경우 criterion으로 `end_throw_error`가 잡히지 않아 정상으로 판단된 것으로 보임.

---

## 취약점 세부 사항

### ❗️취약 코드

#### Sink: `before_zend_execute_API.c:221`

```c
zend_throw_error(exception_ce, message);
```

**문제점**:
* `message`는 외부 입력을 포함한 포맷 문자열로 `zend_vspprintf()`에서 생성됨
* 이 문자열이 포맷 문자열로 그대로 해석되어 CWE-134 취약점 발생 가능

### ✅ 개선 코드

**패치 위치**: `after_zend_execute_API.c:221`

```c
zend_throw_error(exception_ce, "%s", message);
```

**개선 방법**:

* 외부 입력이 포함된 문자열을 포맷 문자열로 직접 사용하지 않고, 고정된 `"%s"`를 사용해 안전하게 출력함
* 이로써 포맷 문자열 취약점(CWE-134) 발생 가능성 제거

---

## 탐지 결과
\* cve 설명에 나온 취약한 함수(Caller)에 대한 슬라이스 관련 데이터만 추출
* 없음