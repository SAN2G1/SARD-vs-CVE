# 📁 CVE-2011-4930

## 🔍 취약점 개요

**🔗 [커밋 링크](https://github.com/htcondor/htcondor/commit/5e5571d1a431eb3c61977b6dd6ec90186ef79867)** | **🔗 [CVE 링크](https://www.cvedetails.com/cve/CVE-2011-4930)** | **🔗 [CWE 링크](https://cwe.mitre.org/data/definitions/134.html)**  

> HTCondor 7.2.0 \~ 7.6.4 및 일부 7.7.x 버전의 `preen.cpp` 파일에서 `fprintf`, `dprintf`에 사용자 입력이 포맷 문자열로 직접 사용되어 발생하는 \*\*형식 문자열 취약점(CWE-134)\*\*입니다. 공격자는 서비스 거부를 유발하거나 포맷 문자열 조작을 통해 메모리 접근이 가능합니다.

**취약점 종류**: \[[CWE-134](https://cwe.mitre.org/data/definitions/134.html)] Use of Externally-Controlled Format String

* **Source**: Condor 시스템이 스캔한 디렉터리 내부의 **파일 경로 문자열(`str`)**이 포함된 `szTmp`  
  → 이 문자열은 `bad_file()` 함수 내에서 디렉터리 경로와 파일명을 결합해 생성되며,  
     공격자가 디스크 상에 포맷 문자열이 포함된 파일명을 만들어 둘 경우, 해당 경로 문자열 전체가 `fprintf()` 및 `dprintf()`에 포맷 문자열로 해석될 수 있음
     
* **취약 조건**: `str` 값에 `%s`, `%x`, `%n` 등의 포맷 문자열이 포함될 경우  
  → 해당 문자열이 `szTmp.sprintf()`를 통해 포맷 문자열로 변환되고, 이후 `fprintf()` 및 `dprintf()`에 **형식 지정 없이 그대로 전달됨**

* **Sink**:  
  - `fprintf(mailer, szTmp.Value());`  
  - `dprintf(D_ALWAYS, szTmp.Value());`  
  이 두 함수는 포맷 문자열을 기대하는데, 사용자가 조작한 문자열이 그대로 포맷 문자열로 해석되어 **포맷 스트링 인젝션이 발생**


---

## 📊 탐지 결과 요약

| 총 슬라이스 수 | 취약으로 탐지 | 정상으로 탐지 |
|----------------|----------------|----------------|
| 24개           | 4개            | 20개           |

\* CVE 설명에 나온 기준 함수(`Caller`: `produce_output`, `criterion`: `dprintf`)는 `dprintf`가 `l_funcs`에 존재하지 않기 때문에 슬라이스 목록에 존재하지 않음

produce_output()에서 추출한 슬라이스 중, Sink(`fprintf()` 함수) 관련 슬라이스 총 4개중 2개 만이 취약하였으나, 4개 모두 **취약으로 탐지됨**


| FileName  | Caller      | Source | Sink  | idx | CWE-ID | category       | criterion | line | label | token\_length | predict |
| --------- | ----------- | ------ | ----- | --- | ------ | -------------- | --------- | ---- | ----- | ------------- | ------- |
| preen_before.cpp | produce_output | FALSE | FALSE | 2 | CWE- | CallExpression | fprintf | 227 | -3 | 145 | 1 |
| preen_before.cpp | produce_output | FALSE | FALSE | 3 | CWE- | CallExpression | fprintf | 228 | -3 | 208 | 1 |
| preen_before.cpp | produce_output | FALSE | FALSE | 4 | CWE- | CallExpression | fprintf | 234 | -3 | 208 | 1 |
| preen_before.cpp | produce_output | FALSE | FALSE | 5 | CWE- | CallExpression | fprintf | 250 | -3 | 145 | 1 |


#### SARD는 잘 탐지하는데 이 CVE는 탐지 못했던 이유

1. **dprintf() -> criterion 리스트에 생성되지 않음**
    - fprintf()는 l_funcs 리스트에 존재하나, dprintf()는 존재하지 않아 슬라이스가 생성되지 않음
    - criterion으로 dprintf()이 잡히지 않아 취약 혹은 정상으로 판단 불가

2. **취약하지 않은 라인이 포함된 슬라이스가 오탐으로 분류됨**

- 슬라이싱 및 토큰화 과정에서 `fprintf(...)` 호출이 포함된 전체 코드 블록이 하나의 슬라이스로 묶임
- 이 중 일부는 실제로 안전한 코드임에도 불구하고, **슬라이스에 취약점을 나타내는 토큰(`fprintf(Var2, Var4.FUNC1())`)이 함께 포함**되어 있었기 때문에
- 모델은 해당 슬라이스 전체를 **취약(label=1)** 로 잘못 판단한 것으로 예상됨

> **취약하지 않은 코드(정상)**

```c
fprintf(mailer, "\n");  // ✅ 포맷 문자열 명시
```

> **정상 코드에 대해 슬라이서가 생성한 실제 슬라이스 中 일부**

```
"\t\tfprintf( mailer, \"\\n\" );\n",
"\t\tfprintf( mailer, szTmp.Value());\n",
```

> **정상 코드에 대해 토크나이저가 생성한 실제 토큰 中 일부**
```
fprintf(Var2,STRING); \n
fprintf(Var2,Var4.FUNC1()); // ⚠ 포맷 미지정
```

- 위처럼 슬라이스에 **포맷 문자열이 명시된 안전한 `fprintf()` 호출**과
  **포맷 문자열 없이 호출된 위험한 `fprintf()` 호출**이 함께 포함됨
- 이로 인해 모델은 슬라이스 전체를 위험하게 판단 → **False Positive 발생**



## 취약점 세부 사항


---

### ❗️ 취약 코드


#### Sink: `preen_before.cpp:224, 228, 333, 234`
```c
	szTmp.sprintf("The condor_preen process has found the following stale condor files on <%s>:\n\n",  get_local_hostname().Value());
	dprintf(D_ALWAYS, szTmp.Value());   // ⚠ 취약!
	if( MailFlag ) {
		fprintf( mailer, "\n" );   
		fprintf( mailer, szTmp.Value());   // ⚠ 취약!
	}

	for( BadFiles->rewind(); (str = BadFiles->next()); ) {
		szTmp.sprintf("  %s\n", str);
		dprintf(D_ALWAYS, szTmp.Value() );  // ⚠ 취약!
		fprintf( mailer, szTmp.Value() );   // ⚠ 취약!     
	}
```

---
### ✅ 개선 코드

#### 1. 포맷 문자열 명시

**패치 위치**: `preen_before.cpp:224, 228, 233, 234`

```c
szTmp.sprintf("The condor_preen process has found the following stale condor files on <%s>:\n\n",  get_local_hostname().Value());
dprintf(D_ALWAYS, "%s", szTmp.Value());   // ✅ 포맷 문자열 명시

if (MailFlag) {
    fprintf(mailer, "\n");
    fprintf(mailer, "%s", szTmp.Value());  // ✅ 포맷 문자열 명시
}

for (BadFiles->rewind(); (str = BadFiles->next()); ) {
    szTmp.sprintf("  %s\n", str);
    dprintf(D_ALWAYS, "%s", szTmp.Value());   // ✅ 포맷 문자열 명시
    fprintf(mailer, "%s", szTmp.Value());     // ✅ 포맷 문자열 명시
}
```

**개선 방법**:

- 외부 입력 또는 동적으로 구성된 문자열을 `dprintf()`나 `fprintf()`에 사용할 경우 반드시 포맷 문자열(`"%s"`)을 명시해야 합니다.
- 포맷 문자열을 명시하지 않으면 `%x`, `%n` 등의 포맷 스트링 공격에 의해 메모리 누출 또는 코드 실행이 유발될 수 있습니다.

---
## 탐지 결과

| FileName         | Caller                    | Source | Sink  | idx | CWE-ID | category       | criterion | line | label | token_length | predict |
|------------------|---------------------------|--------|-------|-----|--------|----------------|-----------|------|-------|--------------|---------|
| preen_before.cpp | usage                     | FALSE  | FALSE | 0   | CWE-   | CallExpression | fprintf   | 104  | -3    | 11           | 0       |
| preen_before.cpp | main                      | FALSE  | FALSE | 1   | CWE-   | CallExpression | free      | 168  | -3    | 56           | 0       |
| preen_before.cpp | produce_output            | FALSE  | FALSE | 2   | CWE-   | CallExpression | fprintf   | 227  | -3    | 145          | 1       |
| preen_before.cpp | produce_output            | FALSE  | FALSE | 3   | CWE-   | CallExpression | fprintf   | 228  | -3    | 208          | 1       |
| preen_before.cpp | produce_output            | FALSE  | FALSE | 4   | CWE-   | CallExpression | fprintf   | 234  | -3    | 208          | 1       |
| preen_before.cpp | produce_output            | FALSE  | FALSE | 5   | CWE-   | CallExpression | fprintf   | 250  | -3    | 145          | 1       |
| preen_before.cpp | check_job_spool_hierarchy | FALSE  | FALSE | 6   | CWE-   | CallExpression | sprintf   | 272  | -3    | 254          | 0       |
| preen_before.cpp | check_spool_dir           | FALSE  | FALSE | 7   | CWE-   | CallExpression | strlen    | 335  | -3    | 188          | 0       |
| preen_before.cpp | check_spool_dir           | FALSE  | FALSE | 8   | CWE-   | CallExpression | strlen    | 339  | -3    | 209          | 0       |
| preen_before.cpp | check_spool_dir           | FALSE  | FALSE | 9   | CWE-   | CallExpression | strlen    | 384  | -3    | 470          | 0       |
| preen_before.cpp | check_spool_dir           | FALSE  | FALSE | 10  | CWE-   | CallExpression | strlen    | 391  | -3    | 457          | 0       |
| preen_before.cpp | is_valid_shared_exe       | FALSE  | FALSE | 11  | CWE-   | CallExpression | strlen    | 456  | -3    | 120          | 0       |
| preen_before.cpp | is_ckpt_file              | FALSE  | FALSE | 12  | CWE-   | CallExpression | strstr    | 481  | -3    | 46           | 0       |
| preen_before.cpp | grab_val                  | FALSE  | FALSE | 13  | CWE-   | CallExpression | strstr    | 501  | -3    | 63           | 0       |
| preen_before.cpp | grab_val                  | FALSE  | FALSE | 14  | CWE-   | CallExpression | atoi      | 502  | -3    | 63           | 0       |
| preen_before.cpp | grab_val                  | FALSE  | FALSE | 15  | CWE-   | CallExpression | strlen    | 502  | -3    | 63           | 0       |
| preen_before.cpp | is_myproxy_file           | FALSE  | FALSE | 16  | CWE-   | CallExpression | sscanf    | 573  | -3    | 33           | 0       |
| preen_before.cpp | is_ccb_file               | FALSE  | FALSE | 17  | CWE-   | CallExpression | strstr    | 587  | -3    | 11           | 0       |
| preen_before.cpp | rec_lock_cleanup          | FALSE  | FALSE | 18  | CWE-   | CallExpression | unlink    | 743  | -3    | 213          | 0       |
| preen_before.cpp | rec_lock_cleanup          | FALSE  | FALSE | 19  | CWE-   | CallExpression | strerror  | 745  | -3    | 328          | 0       |
| preen_before.cpp | init_params               | FALSE  | FALSE | 20  | CWE-   | CallExpression | free      | 811  | -3    | 38           | 0       |
| preen_before.cpp | init_params               | FALSE  | FALSE | 21  | CWE-   | CallExpression | free      | 828  | -3    | 196          | 0       |
| preen_before.cpp | get_machine_state         | FALSE  | FALSE | 22  | CWE-   | CallExpression | free      | 932  | -3    | 115          | 0       |
| preen_before.cpp | get_machine_state         | FALSE  | FALSE | 23  | CWE-   | CallExpression | free      | 940  | -3    | 115          | 0       |
