# 📁 CVE-2019-12973

## 🔍 취약점 개요

🔗 [커밋 링크](https://github.com/uclouvain/openjpeg/commit/48fa2043614d6f90b8d8d6c5f2fcb483c6a7a469) | 🔗 [CVE 링크](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2019-12973) | 🔗 [CWE 링크 (CWE-400)](https://cwe.mitre.org/data/definitions/400.html)

OpenJPEG의 BMP 디코더 함수 `bmp_read_rle8_data()`에서,
조작된 RLE 압축 명령과 잘못된 `width`, `height` 값을 통해 루프 종료 조건이 충족되지 않아
**무한 루프**에 빠지는 **서비스 거부(DoS)** 취약점입니다.

* **취약점 종류:** \[CWE-400] Uncontrolled Resource Consumption
* **취약 조건:** BMP 파일 헤더의 width, height 필드를 조작하여 RLE 압축 명령 시퀀스가 정상 종료되지 않음
* **Sink:** 루프 `while (y < height)` 내 `getc(IN)` 호출이 무한 반복되어 리소스 소비

---

## 탐지 결과 요약

CVE 설명에 기반하여 `bmp_read_rle8_data()` 함수 중심으로 슬라이스를 수집한 결과:

| 총 슬라이스 수 | 취약으로 탐지 | 정상으로 탐지 |
| :------: | :-----: | :-----: |
|   196개   |    0개   |   196개  |

* `bmp_read_rle8_data()` 함수 내 루프(`while (y < height)`)에 대한 슬라이스는 존재했으나,
  모든 슬라이스가 정상으로 판정됨.

| FileName             | Caller                  | Source |  Sink | idx | CWE-ID |    category    | criterion | line | label | token\_length | predict |
| :------------------- | :---------------------- | :----: | :---: | :-: | :----: | :------------: | :-------: | :--: | :---: | :-----------: | :-----: |
| before\_convertbmp.c | bmp\_read\_file\_header |  False | False |  0  |  CWE-  | CallExpression |    getc   |  330 |   -3  |      343      |    0    |
| before\_convertbmp.c | bmp\_read\_file\_header |  False | False |  1  |  CWE-  | CallExpression |    getc   |  331 |   -3  |      343      |    0    |
| before\_convertbmp.c | bmp\_read\_file\_header |  False | False |  2  |  CWE-  | CallExpression |  fprintf  |  334 |   -3  |       23      |    0    |
| before\_convertbmp.c | bmp\_read\_file\_header |  False | False |  3  |  CWE-  | CallExpression |    getc   |  340 |   -3  |      343      |    0    |
| before\_convertbmp.c | bmp\_read\_file\_header |  False | False |  4  |  CWE-  | CallExpression |    getc   |  341 |   -3  |      343      |    0    |

---

## SARD는 잘 탐지하는데 이 CVE는 탐지 못했던 이유

**세 가지 관점에서 분석할 수 있습니다.**

1. **슬라이스 추출 범위 불완전**

   * 슬라이스가 `getc()` 호출 또는 주변 코드 일부만 포함하고,
     `while (y < height)` 루프 구조와 `y` 증가 제어 흐름은 포함되지 않음.

   * 기대하는 슬라이스 예시:

     ```c
     while (y < height) {
         int c = getc(IN);
         written++;
     }
     ```

   * 실제 슬라이스:

     ```c
     int c = getc(IN);
     ```

2. **루프 조건 변수 추적 실패**

   * 루프 종료 조건(`y < height`)에 필요한 `height` 변수는 BMP 파일 헤더에서 유래한 외부 입력.
   * `y`는 루프 내 RLE 명령 처리 로직에 의해 증가하는데,
     특정 비정상 RLE 명령 조합 시 `y`가 증가하지 않는 문제가 발생.
   * 슬라이스가 `y`, `height` 간의 관계와 루프 제어 플로우를 포착하지 못함.

3. **탐지 모델 입력 정보 부족**

   * `vectors.json` 분석 결과, 슬라이스 벡터는 `getc()` 호출 중심의 단편적인 시퀀스로 구성되어 있음.
   * 루프 제어 플로우, 반복 조건, 외부 입력 변수 간 관계가 포함되지 않아 모델이 무한 루프 위험을 인식할 수 없음.

---

## 📁 관련 파일 소개

| 파일명                   | 설명             |
| :-------------------- | :------------- |
| `before_convertbmp.c` | 취약 코드(수정 전) 포함 |
| `after_convertbmp.c`  | 개선 코드(수정 후) 포함 |

---

## ❗️ 취약 코드

📄 **Source:** BMP 헤더에서 입력된 `height` 값 (`before_convertbmp.c:546`)
📄 **Sink:** 무한 반복 `getc(IN)` 호출 (`before_convertbmp.c:547`)

```c
while (y < height) {               // (Line 546) Loop condition
    int c = getc(IN);               // (Line 547) Uncontrolled resource consumption
    ...
}
```

### 📌 취약 흐름 설명

* `height` 값은 BMP 파일의 헤더에서 유래한 외부 입력.
* 루프 진행 변수 `y`는 루프 내 명령어 해석에 따라 증가해야 정상 종료 가능.
* 조작된 RLE 압축 명령을 통해 `y` 증가가 일어나지 않으면,
  루프 종료 조건(`y < height`)이 영구히 참(True)으로 유지되어 무한 반복 발생.
* 이로 인해 **CPU 및 메모리 자원이 무제한 소모**되어 서비스 거부(DoS) 상태에 빠질 수 있음.

---

## ✅ 개선 코드

📄 **패치 위치:** `after_convertbmp.c:610`

```c
if (written != width * height) {
    fprintf(stderr, "warning, image's actual size does not match advertised one\n");
    return OPJ_FALSE;
}
```

### 📌 개선 방법

* 루프 진행 중 디코딩된 픽셀 수를 `written`으로 카운팅.
* 루프 종료 후, 기록된 픽셀 수 `written`과 헤더에 명시된 총 픽셀 수 `width * height`를 비교.
* 불일치 시 오류 반환(`return OPJ_FALSE`)으로 디코딩 실패 처리.
* 조작된 BMP 파일이 무한 루프를 유발하는 것을 사전에 차단.

---

## 🧪 탐지 결과 (슬라이스 상세)

*CVE 설명에 나온 취약한 함수(`Caller`)에 대한 슬라이스 관련 데이터만 추출.*

| FileName             | Caller                  | Source |  Sink | idx | CWE-ID |    category    | criterion | line | label | token\_length | predict |
| :------------------- | :---------------------- | :----: | :---: | :-: | :----: | :------------: | :-------: | :--: | :---: | :-----------: | :-----: |
| before\_convertbmp.c | bmp\_read\_file\_header |  False | False |  0  |  CWE-  | CallExpression |    getc   |  330 |   -3  |      343      |    0    |
| before\_convertbmp.c | bmp\_read\_file\_header |  False | False |  1  |  CWE-  | CallExpression |    getc   |  331 |   -3  |      343      |    0    |
| before\_convertbmp.c | bmp\_read\_file\_header |  False | False |  2  |  CWE-  | CallExpression |  fprintf  |  334 |   -3  |       23      |    0    |
| before\_convertbmp.c | bmp\_read\_file\_header |  False | False |  3  |  CWE-  | CallExpression |    getc   |  340 |   -3  |      343      |    0    |
| before\_convertbmp.c | bmp\_read\_file\_header |  False | False |  4  |  CWE-  | CallExpression |    getc   |  341 |   -3  |      343      |    0    |


