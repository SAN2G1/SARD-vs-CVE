# 📁 CVE-2019-12973

## 🔍 취약점 개요

🔗 [커밋 링크](#) | 🔗 [CVE 링크](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2019-12973) | 🔗 [CWE 링크 (CWE-400)](https://cwe.mitre.org/data/definitions/400.html)

OpenJPEG의 BMP 디코더 기능인 `bmp_read_rle8_data()` 함수에서, 조작된 RLE 압축 명령어와 불일치하는 `width`, `height` 값으로 인해 발생하는 **무한 루프 기반 서비스 거부(DoS)** 취약점입니다.

* **취약점 종류:** \[CWE-400] Uncontrolled Resource Consumption
* **Source:** BMP 파일 내 `width`, `height` 필드
* **취약 조건:** 이미지의 실제 데이터보다 적은 RLE 명령 시퀀스 제공
* **Sink:** `while (y < height)` 루프 조건이 충족되지 않아 무한 반복 발생

---

## 탐지 결과 요약

CVE 설명에 기반하여 `bmp_read_rle8_data()` 함수에서 슬라이스를 수집한 결과:

| 총 슬라이스 수 | 취약으로 탐지 | 정상으로 탐지 |
| :------: | :-----: | :-----: |
|   196개   |    0개   |   196개  |

* 루프 조건 및 `getc()` 호출이 포함된 슬라이스가 존재했으나, **정상으로 탐지됨**

| FileName | Caller                  | Source |  Sink | idx | CWE-ID |    category    | criterion | line | label | token\_length | predict |
| :------- | :---------------------- | :----: | :---: | :-: | :----: | :------------: | :-------: | :--: | :---: | :-----------: | :-----: |
| before.c | bmp\_read\_file\_header |  False | False |  0  |  CWE-  | CallExpression |    getc   |  330 |   -3  |      343      |    0    |
| before.c | bmp\_read\_file\_header |  False | False |  1  |  CWE-  | CallExpression |    getc   |  331 |   -3  |      343      |    0    |
| before.c | bmp\_read\_file\_header |  False | False |  2  |  CWE-  | CallExpression |  fprintf  |  334 |   -3  |       23      |    0    |
| before.c | bmp\_read\_file\_header |  False | False |  3  |  CWE-  | CallExpression |    getc   |  340 |   -3  |      343      |    0    |
| before.c | bmp\_read\_file\_header |  False | False |  4  |  CWE-  | CallExpression |    getc   |  341 |   -3  |      343      |    0    |
| ...      | ...                     |   ...  |  ...  | ... |   ...  |       ...      |    ...    |  ... |  ...  |      ...      |   ...   |

---

## SARD는 잘 탐지하는데 이 CVE는 탐지 못했던 이유


1. **부적절한 criterion**

   SARD의 CWE-400 샘플(`SARD/README.md`)을 기준으로 보면, 일반적으로 무한 루프를 유발하는 패턴은 `fgets`, `read`, `recv` 등의 반복적 I/O 호출이 **criterion**으로 잡히지만,
   이 CVE에서는 `getc()` 함수 호출이 반복되지만, 모델이 이를 criterion으로 인식하지 못한 것으로 추정됩니다.

2. **(예시) 슬라이싱 범위 불완전**

   슬라이스가 `getc()` 호출만 포함하거나, 루프 전체를 포괄하지 못해 루프 진행 제어 변수(`y`, `height`) 간의 관계를 충분히 반영하지 못했습니다.

   기대하는 슬라이스:

   ```c
   int height = get_height_from_header();
   while (y < height) {
       int c = getc(IN);
       written++;
   }
   ```

   원본 슬라이스:

   ```c
   getc(IN);
   written++;
   ```

3. **벡터 단절**

   슬라이스는 `while (y < height)` 루프 전체를 포함하더라도, 벡터 길이 제한(예: 512 토큰)으로 인해 중간에 잘려
   종료 조건(`y` 증가 여부)이나 카운터(`written` 추적)가 슬라이스에 모두 반영되지 않았을 수 있습니다.

---
# 취약점 세부 사항
---
## 📁 관련 파일 소개

| 파일명          | 설명                    |
| :----------- | :-------------------- |
| convertbmp.c | 취약 코드가 포함된 BMP 디코더 파일 |

---

## ❗️ 취약 코드

```c
while (y < height) {
    int c = getc(IN);
    ...
    *pix = c1;
    written++;
}
```

**문제점:**

* `height` 값은 BMP 헤더로부터 유입되어 외부 조작 가능
* `y` 값이 증가하지 않는 시나리오(RLE 압축 명령 조작)에서, 루프 종료 조건이 무한히 참(True)으로 유지
* 결과적으로, 무한 루프에 빠지며 CPU 및 메모리 리소스를 소모, 서비스 거부(DoS) 발생

---

## ✅ 개선 코드

**패치 위치:** `convertbmp.c:610`

```c
if (written != width * height) {
    fprintf(stderr, "warning, image's actual size does not match advertised one\n");
    return OPJ_FALSE;
}
```

**개선 방법:**

* 디코딩된 픽셀 수(`written`)를 카운팅
* 헤더에 명시된 `width * height` 값과 비교
* 불일치할 경우 오류 반환 및 조기 종료
* 입력 데이터 조작에 의해 무한 루프가 발생하지 않도록 차단

---

## 🧪 탐지 결과

*CVE 설명에 나온 취약한 함수(`Caller`)에 대한 슬라이스 데이터만 추출.*

| FileName | Caller                | Source |  Sink | idx | CWE-ID |    category    | criterion | line | label | token\_length | predict |
| :------- | :-------------------- | :----: | :---: | :-: | :----: | :------------: | :-------: | :--: | :---: | :-----------: | :-----: |
| before.c | bmp\_read\_rle8\_data |  False | False | 113 |  CWE-  | CallExpression |    getc   |  546 |   -3  |      469      |    0    |
| before.c | bmp\_read\_rle8\_data |  False | False | 114 |  CWE-  | CallExpression |    getc   |  555 |   -3  |      554      |    0    |
| before.c | bmp\_read\_rle8\_data |  False | False | 115 |  CWE-  | CallExpression |    getc   |  566 |   -3  |      469      |    0    |
| before.c | bmp\_read\_rle8\_data |  False | False | 116 |  CWE-  | CallExpression |    getc   |  578 |   -3  |      661      |    0    |
| before.c | bmp\_read\_rle8\_data |  False | False | 117 |  CWE-  | CallExpression |    getc   |  583 |   -3  |      661      |    0    |
| before.c | bmp\_read\_rle8\_data |  False | False | 118 |  CWE-  | CallExpression |    getc   |  595 |   -3  |      487      |    0    |
| before.c | bmp\_read\_rle8\_data |  False | False | 119 |  CWE-  | CallExpression |    getc   |  603 |   -3  |      469      |    0    |
