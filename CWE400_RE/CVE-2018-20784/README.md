# 📁 CVE-2019-12973

## 🔍 취약점 개요

**🔗 [커밋 링크](https://github.com/uclouvain/openjpeg/commit/8ee335227bbcaf1614124046aa25e53d67b11ec3)** | **🔗 [CVE 링크](https://www.cvedetails.com/cve/CVE-2019-12973/)**

> OpenJPEG의 BMP 디코더 `bmp_read_rle8_data()`에서, 조작된 RLE 압축 명령과 잘못된 `width`, `height` 값에 의해 **루프가 종료되지 않아 무한 루프에 빠지는 서비스 거부(DoS)** 취약점입니다.

**취약점 종류**: \[[CWE-400](https://cwe.mitre.org/data/definitions/400.html)] Uncontrolled Resource Consumption

* **Source**: BMP 파일 내 width/height 필드
* **취약 조건**: 실제 이미지 크기보다 적은 RLE 명령 시퀀스 제공
* **Sink**: `while (y < height)` 루프가 종료 조건을 충족하지 못해 무한 반복

---

## 탐지 결과 요약

CVE 설명에 기반해 `bmp_read_rle8_data()` 함수 중심으로 슬라이스를 수집했을 때:

| 총 슬라이스 수 | 취약으로 탐지 | 정상으로 탐지 |
| -------- | ------- | ------- |
| 196개     | 0개      | 196개    |

슬라이스에 루프 조건, `getc()` 호출 등이 포함되어 있었음에도, **AI 모델은 모두 정상으로 판정함**.

| FileName | Caller                  | Source | Sink  | idx | CWE-ID | category       | criterion | line | label | token\_length | predict |
| -------- | ----------------------- | ------ | ----- | --- | ------ | -------------- | --------- | ---- | ----- | ------------- | ------- |
| before.c | bmp\_read\_file\_header | False  | False | 0   | CWE-   | CallExpression | getc      | 330  | -3    | 343           | 0       |
| before.c | bmp\_read\_file\_header | False  | False | 1   | CWE-   | CallExpression | getc      | 331  | -3    | 343           | 0       |
| before.c | bmp\_read\_file\_header | False  | False | 2   | CWE-   | CallExpression | fprintf   | 334  | -3    | 23            | 0       |
| before.c | bmp\_read\_file\_header | False  | False | 3   | CWE-   | CallExpression | getc      | 340  | -3    | 343           | 0       |
| before.c | bmp\_read\_file\_header | False  | False | 4   | CWE-   | CallExpression | getc      | 341  | -3    | 343           | 0       |

---

## ⚠️ 탐지 결과 문제점

1. **루프 구조 탐지 실패**

   * `while (y < height)` 조건이 반복을 무한히 유지하는 경우임에도, 모델이 이를 정상 동작으로 판단

2. **Source/Sink 식별 미흡**

   * 입력은 BMP 헤더에서 유입되며 `getc()`를 통해 반복되지만, 해당 흐름이 Source/Sink로 태깅되지 않음

3. **카운터 기반 예외 검증 누락**

   * 카운터(`written`)가 실제 기록된 픽셀 수를 추적하지만, 해당 비교 조건이 슬라이스에 포함되지 않거나 인식되지 않음

---

## 🧠 추가 분석 정보

### 🔎 Slicer 추출 코드

```c
while (y < height) {
    int c = getc(IN);
    ...
    *pix = c1;
    written++;
}
```

* 입력값인 `height`가 크고 `getc()`가 계속 반복될 수 있음
* `y`가 증가하지 않는 상황에서는 루프 종료 불가

### 🧩 토큰화된 코드 (심볼화)

```c
while (Var1 < Var2) {
    Var3 = getc(...);
    Var4++;
}
```

* height, written, getc 등 핵심 의미가 추상화되어 모델이 문맥을 파악하지 못함

### 🔤 AI 입력 토큰 예시

```
<s>, while, (, Var1, <, Var2, ), {, Var3, =, getc, (, Var4, ), ;, Var5, ++, ;, }, </s>
```

* 단순 제어 구조로 구성되어 있어 **시맨틱 위험도**를 반영하기 부족

---

## 🧪 개선 방향 제안

1. **루프 구조 위험성 학습 강화**

   * 루프 조건과 반복 카운터의 관계를 분석하여, 종료 조건이 불충분한 경우를 감지할 수 있도록 학습

2. **Source/Sink 추론 개선**

   * 입력이 루프 조건을 지배할 때도 Source로, 자원 반복 소비 지점을 Sink로 태깅해야 함

3. **의미 기반 슬라이스 확장**

   * `written++`, `width * height` 비교 등도 슬라이스에 포함되도록 조정

4. **파일 포맷 기반 위험 시나리오 학습**

   * BMP/PNG/JPEG 등 구조적 포맷 입력에 대한 예외 처리 여부 학습 필요

---

## 취약점 세부 사항

### 📁 관련 파일 소개

| 파일명            | 설명                    |
| -------------- | --------------------- |
| `convertbmp.c` | 취약 함수가 포함된 BMP 디코더 파일 |

---

### ❗️ 취약 코드

```c
while (y < height) {
    int c = getc(IN);
    ...
    *pix = c1;
    written++;
}
```

* `y`가 증가하지 않는 상황이 발생할 수 있음
* `height`는 BMP 헤더에서 유입된 조작 가능 값
* 루프가 종료되지 않고 무한 실행될 수 있음

---

### ✅ 개선 코드

**패치 위치**: `convertbmp.c:610` 부근

```c
if (written != width * height) {
    fprintf(stderr, "warning, image's actual size does not match advertized one\n");
    return OPJ_FALSE;
}
```

**개선 방법**:

* 실제로 기록된 픽셀 수를 카운팅하여, 헤더에 명시된 `width * height`와 불일치할 경우 오류를 반환
* 조작된 BMP 파일이 무한 루프를 유발하지 않도록 차단

---

## 탐지 결과

\* cve 설명에 나온 취약한 함수(Caller)에 대한 슬라이스 관련 데이터만 추출

| FileName | Caller                | Source | Sink  | idx | CWE-ID | category       | criterion | line | label | token\_length | predict |
| -------- | --------------------- | ------ | ----- | --- | ------ | -------------- | --------- | ---- | ----- | ------------- | ------- |
| before.c | bmp\_read\_rle8\_data | False  | False | 113 | CWE-   | CallExpression | getc      | 546  | -3    | 469           | 0       |
| before.c | bmp\_read\_rle8\_data | False  | False | 114 | CWE-   | CallExpression | getc      | 555  | -3    | 554           | 0       |
| before.c | bmp\_read\_rle8\_data | False  | False | 115 | CWE-   | CallExpression | getc      | 566  | -3    | 469           | 0       |
| before.c | bmp\_read\_rle8\_data | False  | False | 116 | CWE-   | CallExpression | getc      | 578  | -3    | 661           | 0       |
| before.c | bmp\_read\_rle8\_data | False  | False | 117 | CWE-   | CallExpression | getc      | 583  | -3    | 661           | 0       |
| before.c | bmp\_read\_rle8\_data | False  | False | 118 | CWE-   | CallExpression | getc      | 595  | -3    | 487           | 0       |
| before.c | bmp\_read\_rle8\_data | False  | False | 119 | CWE-   | CallExpression | getc      | 603  | -3    | 469           | 0       |

---


