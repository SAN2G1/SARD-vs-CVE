# 📁 CVE-2018-20784

## 🔍 취약점 개요

🔗 [커밋 링크](https://github.com/php/php-src/commit/0f8cf3b8497dc45c010c44ed9e96518e11e19fc3) | 🔗 [CVE 링크](https://www.cvedetails.com/cve/CVE-2018-20784/) | 🔗 [CWE 링크 (CWE-400)](https://cwe.mitre.org/data/definitions/400.html)

Linux 커널 Completely Fair Scheduler(CFS)의 `update_blocked_averages()` 함수 내 리스트 순회 루프에서,
비정상적인 리스트 상태(`rq->leaf_cfs_rq_list`)로 인해 루프가 종료되지 않고 **무한 루프**에 빠지는 **서비스 거부(DoS)** 취약점입니다.

* **취약점 종류:** \[CWE-400] Uncontrolled Resource Consumption
* **취약 조건:** 리스트 순회 중 손상된 엔트리 접근, 포인터 유지 실패
* **Sink:** `for_each_leaf_cfs_rq_safe()` 매크로 반복문 내 무한 순회

---

## 탐지 결과 요약

CVE 설명을 기반으로 `update_blocked_averages()` 함수 중심으로 슬라이스를 수집한 결과:

| 총 슬라이스 수 | 취약으로 탐지 | 정상으로 탐지 |
| :------: | :-----: | :-----: |
|    5개    |    2개   |    3개   |

* 그러나 취약 함수인 `update_blocked_averages()` 함수에 대한 슬라이스는 생성되지 않았으며,
* 모두 다른 함수(`memset()` 호출)에서 생성된 슬라이스입니다.

| FileName | Caller                          | Source |  Sink | idx | CWE-ID |    category    | criterion | line | label | token\_length | predict |
| :------- | :------------------------------ | :----: | :---: | :-: | :----: | :------------: | :-------: | :--: | :---: | :-----------: | :-----: |
| before.c | init\_entity\_runnable\_average |  False | False |  0  |  CWE-  | CallExpression |   memset  |  703 |   -3  |       85      |    1    |
| before.c | update\_numa\_stats             |  False | False |  1  |  CWE-  | CallExpression |   memset  | 1476 |   -3  |       95      |    1    |
| before.c | update\_task\_scan\_period      |  False | False |  2  |  CWE-  | CallExpression |   memse항
3. **벡터 단절**

   슬라이스에 포함된 코드가 벡터로 변환되는 과정에서 리스트 순회, 포인터 연산 등의 복잡한 커널 내부 구조가 반영되지 않았고,
   벡터 길이 제한으로 인해 반복문 흐름 전체를 학습 데이터로 전달할 수 없었습니다.

---
## 탐지 결과 요약
---
## 📁 관련 파일 소개

| 파일명             | 설명             |
| :-------------- | :------------- |
| `before_fair.c` | 취약 코드(수정 전) 포함 |
| `after_fair.c`  | 개선 코드(수정 후) 포함 |

---

## ❗️ 취약 코드

```c
for_each_leaf_cfs_rq_safe(rq, cfs_rq, pos) {
    ...
}
```

**문제점:**

* 리스트 순회 구조(`rq->leaf_cfs_rq_list`)의 무결성이 손상된 경우, 다음 엔트리로의 이동이 정상적으로 이루어지지 않음
* 포인터(`pos`)가 갱신되지 않아 루프 종료 조건이 충족되지 않고 무한 루프에 빠짐
* 결과적으로, 고부하 상황에서 시스템 응답 불가, 커널 lockup 등의 심각한 장애 유발

---

## ✅ 개선 코드

**패치 위치:** `after_fair.c:1152`

```c
#define for_each_leaf_cfs_rq(rq, cfs_rq) \
    list_for_each_entry_rcu(cfs_rq, &rq->leaf_cfs_rq_list, leaf_cfs_rq_list)
```

**개선 방법:**

* `list_for_each_entry_rcu()`를 통해 **RCU(Read-Copy-Update)** 기반 안전 리스트 순회를 적용
* RCU 보호 하에 리스트 변형 시에도 노드 삭제 및 접근 충돌 방지
* 루프 탈출 보장을 통해 무한 루프 및 커널 hang 가능성 제거

---

## 🧪 탐지 결과 (슬라이스 상세)

*CVE 설명에 나온 취약한 함수(`Caller`)에 대한 슬라이스 관련 데이터만 추출.*

| FileName | Caller                          | Source |  Sink | idx | CWE-ID |    category    | criterion | line | label | token\_length | predict |
| :------- | :------------------------------ | :----: | :---: | :-: | :----: | :------------: | :-------: | :--: | :---: | :-----------: | :-----: |
| before.c | init\_entity\_runnable\_average |  False | False |  0  |  CWE-  | CallExpression |   memset  |  703 |   -3  |       85      |    1    |
| before.c | update\_numa\_stats             |  False | False |  1  |  CWE-  | CallExpression |   memset  | 1476 |   -3  |       95      |    1    |
| before.c | update\_task\_scan\_period      |  False | False |  2  |  CWE-  | CallExpression |   memset  | 1978 |   -3  |      409      |    0    |
| before.c | task\_numa\_fault               |  False | False |  3  |  CWE-  | CallExpression |   memset  | 2375 |   -3  |      419      |    0    |
| before.c | update\_sg\_lb\_stats           |  False | False |  4  |  CWE-  | CallExpression |   memset  | 8172 |   -3  |      390      |    0    |


