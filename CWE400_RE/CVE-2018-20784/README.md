# 📁 CVE-2018-20784

## 🔍 취약점 개요

**🔗 [커밋 링크](https://github.com/php/php-src/commit/0f8cf3b8497dc45c010c44ed9e96518e11e19fc3)**| **🔗 [CVE 링크](https://www.cvedetails.com/cve/CVE-2018-20784/)**

> Linux 커널 CFS 스케줄러의 `update_blocked_averages()` 함수 내 리스트 순회 루프가 비정상적인 리스트 상태(`rq->leaf_cfs_rq_list`)에서 종료되지 않고 **무한 루프에 빠지는 DoS 취약점**입니다.
> 이는 고부하 상황에서 시스템 응답 중단, 커널 lockup 등의 문제를 유발할 수 있습니다.

**취약점 종류**: \[[CWE-400](https://cwe.mitre.org/data/definitions/400.html)] Uncontrolled Resource Consumption

* **Source**: CFS 런큐 리스트(`leaf_cfs_rq_list`)의 비정상 조작 또는 정렬 순서 오류
* **취약 조건**: 리스트 순회 중 제거된 엔트리 접근, `tmp_alone_branch` 포인터 유지 실패
* **Sink**: `for_each_leaf_cfs_rq_safe()` 매크로 반복문 내 무한 순회

---

## 탐지 결과 요약

| 총 슬라이스 수 | 취약으로 탐지 | 정상으로 탐지 |
| -------- | ------- | ------- |
| 5개       | 2개      | 3개      |

그러나 **취약 함수인 `update_blocked_averages()` 함수는 슬라이스에 포함되지 않았으며**, 모두 다른 함수들에서 생성된 `memset()` 호출 슬라이스입니다.

---

## ⚠️ 탐지 결과 문제점

1. **핵심 취약 함수 누락**

   * 실제 취약한 `update_blocked_averages()` 함수에 대한 슬라이스가 생성되지 않음

2. **무한 루프 구조 탐지 실패**

   * `for_each_leaf_cfs_rq_safe()` 반복문이 조건 없이 순회할 수 있는 구조를 모델이 인식하지 못함

3. **CFS 리스트 구조 이해 부족**

   * `rq->leaf_cfs_rq_list`의 리스트 상태가 손상될 경우 발생하는 문제를 반영하지 못함

4. **불충분한 컨텍스트 및 흐름 추적**

   * `tmp_alone_branch` → `leaf_cfs_rq_list` 간의 포인터 연산 관계와 리스트 연결 문제를 슬라이스에 담지 못함

---

## 🧠 추가 분석 정보

### 🔎 Slicer 추출 코드

> 취약 함수 `update_blocked_averages()`는 슬라이스에 포함되지 않았으며, 분석 가능한 코드는 없음

---

### 🧩 토큰화된 코드 (예시)

```c
memset(&entity->avg, 0, sizeof(struct sched_avg));
```

* 슬라이스는 `memset()` 기반 단순 초기화 루틴만 포함됨
* `cfs_rq_list` 또는 반복문은 전혀 반영되지 않음

---

### 🔤 AI 입력 토큰 예시

```
<s>, memset, (, Var1, ,, 0, ,, sizeof, (, struct, sched_avg, ), ), ;, </s>
```

* 단일 초기화 함수 호출로, 반복 구조나 리스트 연산이 포함되어 있지 않음

---

## 🧪 개선 방향 제안

1. **취약 함수 기반 우선 슬라이싱**

   * 커널 주요 루틴(`update_blocked_averages`)에 대한 슬라이스를 우선 생성하도록 전략 강화

2. **리스트 순회 기반 루프 탐지 강화**

   * 반복문과 포인터 조작이 결합된 구조(`list_for_each_entry_safe`)의 위험성 인지 강화

3. **커널 자료구조 맥락 학습**

   * `cfs_rq`, `rq`, `leaf_cfs_rq_list` 간 연계관계를 모델이 인지할 수 있도록 학습데이터 개선

4. **함수 간 슬라이스 연결 지원**

   * 반복문 내부에서 루프 종료조건이 외부 포인터 변수와 관련된 경우 이를 추적할 수 있는 분석 강화

---

## 취약점 세부 사항

### 📁 관련 파일 소개

| 파일명      | 설명                  |
| -------- | ------------------- |
| `fair.c` | 커널 스케줄링 관련 함수 정의    |
| `diff.c` | 취약 코드 패치 diff 포함 파일 |

---

### ❗️ 취약 코드

```c
for_each_leaf_cfs_rq_safe(rq, cfs_rq, pos) {
    ...
}
```

* 리스트 엔트리 제거 또는 포인터 손상 시 반복문 탈출 불가
* 결과적으로 커널 hang 발생

---

### ✅ 개선 코드

```c
#define for_each_leaf_cfs_rq(rq, cfs_rq) \
    list_for_each_entry_rcu(cfs_rq, &rq->leaf_cfs_rq_list, leaf_cfs_rq_list)
```

* 불완전한 순회 매크로를 제거하고, RCU 기반 안전 순회 구조로 대체
* 리스트 손상 시 루프 탈출 실패 문제를 구조적으로 차단

---

## 탐지 결과

\* cve 설명에 나온 취약한 함수(Caller)에 대한 슬라이스 관련 데이터만 추출

> 실제 취약 함수인 `update_blocked_averages()` 함수에 해당하는 슬라이스는 **포함되지 않음**
> 아래는 모델이 탐지한 상위 5개 슬라이스입니다:

| FileName | Caller                          | Source | Sink  | idx | CWE-ID | category       | criterion | line | label | token\_length | predict |
| -------- | ------------------------------- | ------ | ----- | --- | ------ | -------------- | --------- | ---- | ----- | ------------- | ------- |
| before.c | init\_entity\_runnable\_average | False  | False | 0   | CWE-   | CallExpression | memset    | 703  | -3    | 85            | 1       |
| before.c | update\_numa\_stats             | False  | False | 1   | CWE-   | CallExpression | memset    | 1476 | -3    | 95            | 1       |
| before.c | update\_task\_scan\_period      | False  | False | 2   | CWE-   | CallExpression | memset    | 1978 | -3    | 409           | 0       |
| before.c | task\_numa\_fault               | False  | False | 3   | CWE-   | CallExpression | memset    | 2375 | -3    | 419           | 0       |
| before.c | update\_sg\_lb\_stats           | False  | False | 4   | CWE-   | CallExpression | memset    | 8172 | -3    | 390           | 0       |

---

필요하시면 이 보고서를 PDF, HTML 또는 GitHub 정적 페이지로도 변환해드릴 수 있습니다.
