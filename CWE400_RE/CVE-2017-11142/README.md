# 📁 CVE-2017-11142

## 🔍 취약점 개요
**🔗 [커밋 링크](https://github.com/php/php-src/commit/2b0f239b211c7544ebc7a4cd2c977a5b7a11ed8a)** | **🔗 [CVE 링크](https://www.cvedetails.com/cve/CVE-2017-11142/)** | **[취약점 종류: [CWE-400] Resource Exhaustion](https://cwe.mitre.org/data/definitions/400.html)** 

> PHP의 POST 변수 처리 과정에서 발생하는 리소스 소진 취약점입니다. `add_post_var()` 함수에서 메모리 검색 시 이미 검사한 영역을 다시 검사하지 않도록 수정되었습니다.

* **취약 조건**: POST 데이터 처리 시 동일한 메모리 영역을 반복적으로 검사
* **Sink**: `memchr()` 함수를 통한 메모리 검색

### 취약점 발생 시나리오
```
POST 데이터: "name=value&age=20&city=seoul"

첫 번째 검사: "name=value&age=20&city=seoul"
               ^
두 번째 검사: "name=value&age=20&city=seoul"
                      ^
세 번째 검사: "name=value&age=20&city=seoul"
                             ^
```
- 매 검사마다 처음부터 끝까지 다시 검사
- 이미 검사한 부분을 다시 검사하는 비효율 발생
- 데이터가 클 경우 성능 저하와 메모리 사용량 증가

## 탐지 결과 요약
cve 설명에 나온 취약한 함수(Caller)에 대한 슬라이스만 고려했을 때,

| 총 슬라이스 수 |  취약으로 탐지 | 정상으로 탐지 |
| --------  | -- | -- |
| 14개       | 0개 | 14개 |

#### SARD는 잘 탐지하는데 이 CVE는 탐지 못했던 이유

AI 모델은 CWE-400의 경우 메모리 할당/해제 함수가 슬라이스에 존재해야 취약으로 판단하는데, 이 취약점의 경우 `memchr()` 함수만 포함되어 있어 정상으로 판단된 것으로 보임.

---

### ⚠️ 탐지 결과 문제점

현재 탐지 결과에서 모든 슬라이스가 정상(라벨 0)으로 판정되었으나, 이는 다음과 같은 기술적 한계로 인한 오탐으로 판단됩니다:

1. **정적 분석의 한계**
   - 모든 슬라이스가 정상으로 탐지됨
   - 정적 분석 도구가 런타임 성능 문제를 탐지하지 못함
   - CWE-400과 같은 리소스 소진 취약점은 정적 분석으로는 탐지가 어려움
   - 📄 근거: `test_output.csv`의 predict 값이 모두 0으로 표시됨

2. **취약점의 특성**
   - 취약점이 여러 함수에 걸쳐 존재
   - 메모리 검색의 비효율성이 주요 문제
   - 이러한 성능 관련 문제는 정적 분석으로는 파악이 어려움
   - 📄 근거: `before_php_variables.c`의 여러 함수에서 메모리 검색 수행

### Source와 Sink 분석
- **Source 함수 분류**:
  - `add_post_var`: POST 데이터 처리 함수 (2개 슬라이스)
  - `add_post_vars`: POST 변수 처리 함수 (1개 슬라이스)
  - `php_auto_globals_create_*`: 자동 전역 변수 생성 함수들 (10개 슬라이스)
  - `check_http_proxy`: HTTP 프록시 검사 함수 (1개 슬라이스)

- **Sink 함수 분류**:
  - `memchr`: 메모리 검색 함수 (2개 슬라이스)
  - `memmove`: 메모리 이동 함수 (1개 슬라이스)
  - `strchr`: 문자열 검색 함수 (10개 슬라이스)
  - `getenv`: 환경 변수 검색 함수 (1개 슬라이스)

---

## 취약점 세부 사항

### 📁 관련 파일 소개
| 파일명 | 설명 |
| ------ | ---- |
| `CVE-2017-11142.diff` | 패치 정보와 취약점 기본 정보 |
| `before_php_variables.c` | 취약한 소스 코드 |
| `after_php_variables.c` | 패치된 소스 코드 |
| `test_output.csv` | 슬라이스 분석 결과와 통계 |
| `slicer_result.json` | 상세 슬라이스 정보 |
| `slicer_result.symbolized.json` | 심볼화된 슬라이스 정보 |
| `vectors.json` | 테스트 벡터와 취약점 트리거 조건 |

---

### ❗️ 취약 코드

**문제점**:
`add_post_var()` 함수에서 POST 데이터를 처리할 때, 이미 검사한 메모리 영역을 다시 검사하는 문제가 있었습니다. 이로 인해 동일한 메모리 영역을 반복적으로 검사하면서 리소스가 소진될 수 있었습니다.

#### 취약한 구조체 정의 (`before_php_variables.c:234`)
```c
typedef struct post_var_data {
    smart_str str;    // POST 데이터를 저장하는 문자열 버퍼
    char *ptr;        // 현재 처리 중인 위치
    char *end;        // 데이터의 끝 위치
    uint64_t cnt;     // 처리된 변수 수
} post_var_data_t;
```

#### Sink: `before_php_variables.c:253`
```c
// POST 데이터에서 '&' 문자를 찾아 다음 변수의 시작 위치를 찾음
// 문제점: 매번 처음부터 끝까지 검사하여 비효율적
vsep = memchr(var->ptr, '&', var->end - var->ptr);

// 데이터 처리 후 다음 검사를 위해 포인터 이동
var->ptr = vsep + (vsep != var->end);
```

---

### ✅ 개선 코드

**패치된 구조체 정의** (`after_php_variables.c:234`)
```c
typedef struct post_var_data {
    smart_str str;    // POST 데이터를 저장하는 문자열 버퍼
    char *ptr;        // 현재 처리 중인 위치
    char *end;        // 데이터의 끝 위치
    uint64_t cnt;     // 처리된 변수 수
    size_t already_scanned;  // 이미 검사한 바이트 수를 추적
} post_var_data_t;
```

**패치된 함수** (`after_php_variables.c:253`)
```c
static zend_bool add_post_var(zval *arr, post_var_data_t *var, zend_bool eof TSRMLS_DC)
{
    // start 변수 추가
    char *start, *ksep, *vsep, *val;
    size_t klen, vlen;
    /* FIXME: string-size_t */
    unsigned int new_vlen;

    if (var->ptr >= var->end) {
        return 0;
    }

    // 이미 검사한 위치 이후부터 검사 시작
    start = var->ptr + var->already_scanned;
    // 검색 범위를 최적화하여 메모리 검색 수행
    vsep = memchr(start, '&', var->end - start);
    if (!vsep) {
        if (!eof) {
            // EOF가 아닌 경우, 현재까지 검사한 위치 저장
            var->already_scanned = var->end - var->ptr;
            return 0;
        } else {
            vsep = var->end;
        }
    }

    // ... (중간 코드 생략) ...

    // 데이터 처리 후 다음 검사를 위해 포인터 이동
    var->ptr = vsep + (vsep != var->end);
    // 다음 검사를 위해 already_scanned 초기화
    var->already_scanned = 0;
    return 1;
}

// add_post_vars 함수의 메모리 이동 최적화
static inline int add_post_vars(zval *arr, post_var_data_t *vars, zend_bool eof TSRMLS_DC)
{
    // ... (중간 코드 생략) ...

    // 불필요한 메모리 이동 방지
    if (!eof && vars->str.c != vars->ptr) {
        memmove(vars->str.c, vars->ptr, vars->str.len = vars->end - vars->ptr);
    }
    return SUCCESS;
}
```

---

### 탐지 결과
\* 취약한 함수(Caller)에 대한 슬라이스 관련 데이터만 추출

|FileName |Caller |Source|Sink |idx|CWE-ID|category |criterion|line|label|token_length|predict|
|---------|-------|------|-----|---|------|---------|---------|----|-----|------------|-------|
|before_php_variables.c|add_post_var|False|False|0|CWE-|CallExpression|memchr|253|-3|290|0|
|before_php_variables.c|add_post_var|False|False|1|CWE-|CallExpression|memchr|262|-3|290|0|
|before_php_variables.c|add_post_vars|False|False|2|CWE-|CallExpression|memmove|308|-3|152|0|
|before_php_variables.c|php_auto_globals_create_get|False|False|3|CWE-|CallExpression|strchr|720|-3|0|0|
|before_php_variables.c|php_auto_globals_create_get|False|False|4|CWE-|CallExpression|strchr|720|-3|0|0|
|before_php_variables.c|php_auto_globals_create_post|False|False|5|CWE-|CallExpression|strchr|743|-3|0|0|
|before_php_variables.c|php_auto_globals_create_post|False|False|6|CWE-|CallExpression|strchr|743|-3|0|0|
|before_php_variables.c|php_auto_globals_create_cookie|False|False|7|CWE-|CallExpression|strchr|769|-3|0|0|
|before_php_variables.c|php_auto_globals_create_cookie|False|False|8|CWE-|CallExpression|strchr|769|-3|0|0|
|before_php_variables.c|check_http_proxy|False|False|9|CWE-|CallExpression|getenv|811|-3|63|0|
|before_php_variables.c|php_auto_globals_create_server|False|False|10|CWE-|CallExpression|strchr|826|-3|0|0|
|before_php_variables.c|php_auto_globals_create_server|False|False|11|CWE-|CallExpression|strchr|826|-3|0|0|
|before_php_variables.c|php_auto_globals_create_env|False|False|12|CWE-|CallExpression|strchr|874|-3|0|0|
|before_php_variables.c|php_auto_globals_create_env|False|False|13|CWE-|CallExpression|strchr|874|-3|0|0|